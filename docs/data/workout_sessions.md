# workout_sessions

## 1. 테이블 개요 (Table Overview)
| 항목 | 내용 |
| :--- | :--- |
| **테이블 명** | `workout_sessions` |
| **설명** | 사용자가 특정 날짜에 수행한 운동 전체를 하나의 '세션' 단위로 묶어주는 테이블입니다. 운동 시작 시점의 루틴 전체를 JSONB 스냅샷으로 저장하여 이력 데이터의 불변성을 보장합니다. |

## 2. 컬럼 명세 (Column Specification)
- `id`: 운동 세션 고유 ID (Primary Key)
- `user_id`: 운동을 수행한 사용자 ID (`users.id` 참조)
- `session_date`: 운동을 시작한 날짜 및 시간
- `routine_id`: **(참조용)** 이 세션의 기반이 된 원본 루틴의 ID. 원본 루틴으로 바로 가기 위한 링크 역할이며, 삭제되면 `NULL`이 될 수 있습니다.
- `routine_snapshot`: **(JSONB)** 운동을 시작할 당시의 루틴 전체(운동, 세트, 목표 등)를 복사하여 저장한 스냅샷 데이터입니다.
- `notes`: 해당 운동 세션 전체에 대한 메모

## 3. `routine_snapshot` JSONB 구조 예시
```json
{
  "routineName": "월요일 가슴 루틴",
  "description": "가슴 근육 전체를 자극하는 루틴입니다.",
  "exercises": [
    {
      "exerciseName": "벤치프레스",
      "displayOrder": 0,
      "notes": "마지막 세트는 드롭세트로",
      "sets": [
        {"set": 1, "weight_kg": 50, "reps": 12},
        {"set": 2, "weight_kg": 60, "reps": 10}
      ]
    },
    {
      "exerciseName": "인클라인 덤벨 프레스",
      "displayOrder": 1,
      "notes": null,
      "sets": [
        {"set": 1, "weight_kg": 20, "reps": 12},
        {"set": 2, "weight_kg": 20, "reps": 12}
      ]
    }
  ]
}
```

## 4. DDL 쿼리문 (DDL Query)
```sql
-- 테이블이 이미 존재할 경우 삭제
DROP TABLE IF EXISTS workout_sessions CASCADE;

-- workout_sessions 테이블 생성
CREATE TABLE workout_sessions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL,
    session_date TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    routine_id BIGINT,
    routine_snapshot JSONB,

    notes TEXT,
    
    CONSTRAINT fk_session_user FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE, -- 유저가 삭제되면 같이 사라짐
    CONSTRAINT fk_session_routine FOREIGN KEY(routine_id) REFERENCES routines(id) ON DELETE SET NULL -- 루틴이 사라지더라도 남음
);

-- 인덱스 생성
CREATE INDEX idx_workout_sessions_user_id ON workout_sessions(user_id);
-- JSONB 내부 검색을 위한 GIN 인덱스 (선택 사항, 추후 분석 기능 필요시)
CREATE INDEX idx_workout_sessions_snapshot_gin ON workout_sessions USING GIN(routine_snapshot);

-- 주석 추가
COMMENT ON TABLE workout_sessions IS '사용자의 하루 운동 전체를 묶어주는 세션 단위 테이블';
COMMENT ON COLUMN workout_sessions.routine_id IS '운동 기록의 기반이 된 원본 루틴 ID (바로가기용)';
COMMENT ON COLUMN workout_sessions.routine_snapshot IS '운동 시작 시점의 루틴 전체 정보를 복사한 JSONB 데이터 (이력 보존용)';