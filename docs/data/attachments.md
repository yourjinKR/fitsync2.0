# 개념 
- 서비스 내의 모든 첨부파일(이미지, 영상 등)을 중앙에서 관리하는 테이블입니다.
- '다형적 관계' 설계를 사용하여, 하나의 테이블로 여러 도메인(회원 프로필, 채팅, 게시글 등)의 파일을 모두 관리할 수 있습니다.
- attachable_type과 attachable_id 컬럼을 통해 파일이 어느 도메인의 어떤 데이터에 속하는지를 구분합니다.
- display_order 컬럼을 통해 목록 내에서의 정렬 순서를 관리할 수 있습니다.

# 컬럼 명세
- `id`: 첨부파일 고유 ID (Primary Key)
- `original_filename`: 사용자가 업로드한 원본 파일명
- `file_url`: AWS S3 등 파일 저장소의 접근 URL
- `storage_public_id`: AWS S3의 Object Key와 같이 저장소에서 파일을 식별하는 고유 키
- `file_size_bytes`: 파일 크기 (Byte 단위)
- `mime_type`: 파일의 종류를 나타내는 신분증 (예: `image/jpeg`)
- `file_extension`: 파일 확장자 (예: `jpg`, `png`)
- `created_at`: 레코드 생성일시
- `uploader_user_id`: 파일을 업로드한 사용자의 ID (`users.id` 참조)
- `attachable_type`: 파일이 첨부된 도메인의 타입 (예: `USER_PROFILE`, `CHAT_MESSAGE`)
- `attachable_id`: 해당 도메인 레코드의 실제 ID (예: `users.id`, `chat_messages.id`)
- `display_order`: 목록 내에서의 정렬 순서 (숫자가 작을수록 먼저 표시)

# 쿼리문
```sql
-- 테이블이 이미 존재할 경우 의존하는 객체와 함께 삭제합니다.
DROP TABLE IF EXISTS attachments CASCADE;

-- attachments 테이블 생성
CREATE TABLE attachments (
    -- 1. 파일 자체의 고유 정보
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    original_filename VARCHAR(255) NOT NULL,
    file_url TEXT NOT NULL, -- AWS S3 등 파일 저장소의 URL
    storage_public_id VARCHAR(500) UNIQUE, -- 파일 저장소의 고유 키 (S3 Object Key). 중복 방지를 위해 UNIQUE 제약 추가
    file_size_bytes BIGINT,
    mime_type VARCHAR(100),
    file_extension VARCHAR(10),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- 2. 파일을 업로드한 사용자 정보 ("누가")
    uploader_user_id BIGINT, -- 업로더가 비회원일 수도 있다면 NULL 허용, 회원만 가능하면 NOT NULL
    
    -- 3. 파일이 첨부된 위치 정보 ("어디에")
    attachable_type VARCHAR(50) NOT NULL,
    attachable_id BIGINT NOT NULL,
    
    -- 4. 정렬 순서
    display_order SMALLINT NOT NULL DEFAULT 0, -- 목록 내에서의 정렬 순서 (숫자가 작을수록 먼저 표시)
    
    -- 외래 키 제약 조건
    CONSTRAINT fk_uploader_user FOREIGN KEY(uploader_user_id) REFERENCES users(id) ON DELETE SET NULL
);

-- 자주 사용될 조회 조건을 위한 인덱스 생성
CREATE INDEX idx_attachments_uploader ON attachments(uploader_user_id);
-- 첨부 위치 및 순서로 매우 빠르게 조회하기 위한 복합 인덱스 (매우 중요!)
CREATE INDEX idx_attachments_attachable_order ON attachments(attachable_type, attachable_id, display_order);


-- 주석 추가
COMMENT ON TABLE attachments IS '프로필, 채팅 등 모든 첨부파일을 관리하는 중앙 테이블';
COMMENT ON COLUMN attachments.storage_public_id IS 'AWS S3 등의 파일 저장소에서 사용하는 고유 키 (Object Key)';
COMMENT ON COLUMN attachments.uploader_user_id IS '파일을 업로드한 회원의 ID (users.id)';
COMMENT ON COLUMN attachments.attachable_type IS '파일이 첨부된 도메인/테이블의 타입 (예: USER_PROFILE, USER_INFO, CHAT_MESSAGE, REVIEW, POST)';
COMMENT ON COLUMN attachments.attachable_id IS '첨부된 도메인의 실제 ID (예: users.id, posts.id)';
COMMENT ON COLUMN attachments.display_order IS '첨부된 목록 내에서의 정렬 순서 (0부터 시작, 숫자가 작을수록 우선순위 높음)';


```