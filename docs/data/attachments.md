# attachments

## 1. 테이블 개요 (Table Overview)
| 항목 | 내용 |
| :--- | :--- |
| **테이블 명** | `attachments` |
| **설명** | 프로필 이미지, 채팅 메시지, 게시글 등 서비스 내 모든 도메인의 첨부파일을 중앙에서 관리하는 테이블입니다. '다형적 관계' 설계를 통해 여러 종류의 부모 레코드에 파일을 연결합니다. |

## 2. 컬럼 명세 (Column Specification)
- `id`: 첨부파일 고유 ID (Primary Key)
- `original_filename`: 사용자가 업로드한 원본 파일명
- `file_url`: 파일 저장소(AWS S3 등)의 접근 URL
- `storage_public_id`: 저장소에서 파일을 식별하는 고유 키 (예: S3 Object Key)
- `file_size_bytes`: 파일 크기 (Byte 단위)
- `mime_type`: 파일의 MIME 타입 (예: `image/jpeg`)
- `file_extension`: 파일 확장자 (예: `jpg`, `png`)
- `created_at`: 레코드 생성일시
- `uploader_user_id`: 파일을 업로드한 사용자의 ID (`users.id` FK)
- `attachable_type`: 파일이 첨부된 도메인의 타입 (예: `USER_PROFILE`)
- `attachable_id`: 해당 도메인 레코드의 ID (예: `users.id`)
- `display_order`: 목록 내에서의 정렬 순서

## 3. 관계 (Relations)
- **`users` (N:1)**: 하나의 사용자는 여러 파일을 업로드할 수 있습니다. (`uploader_user_id` -> `users.id`)
- **Polymorphic Relation (1:N)**: 하나의 첨부파일은 `attachable_type`과 `attachable_id`를 통해 특정 도메인(예: `users`, `posts`, `chat_messages` 등)의 한 레코드에 속합니다.

## 4. 인덱스 (Indexes)
| 인덱스 명 | 컬럼 | 설명 |
| :--- | :--- | :--- |
| `idx_attachments_uploader` | `(uploader_user_id)` | 특정 사용자가 업로드한 파일들을 빠르게 조회하기 위해 사용됩니다. |
| `idx_attachments_attachable_order` | `(attachable_type, attachable_id, display_order)` | 특정 도메인에 첨부된 파일 목록을 정렬 순서대로 빠르게 조회하기 위한 핵심 복합 인덱스입니다. |

## 5. DDL 쿼리문 (DDL Query)
```sql
-- 테이블이 이미 존재할 경우 의존하는 객체와 함께 삭제합니다.
DROP TABLE IF EXISTS attachments CASCADE;

-- 타입 지정
DROP TYPE IF EXISTS attachable_type CASCADE;
CREATE TYPE attachable_type AS ENUM ('USER_PROFILE', 'EXERCISE_INFO', 'POST', 'CHAT');

-- attachments 테이블 생성
CREATE TABLE attachments (
    -- 1. 파일 자체의 고유 정보
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    original_filename VARCHAR(255) NOT NULL,
    file_url TEXT NOT NULL,
    storage_public_id VARCHAR(500) UNIQUE,
    file_size_bytes BIGINT,
    mime_type VARCHAR(100),
    file_extension VARCHAR(10),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,

    -- 2. 파일을 업로드한 사용자 정보 ("누가")
    uploader_user_id BIGINT,

    -- 3. 파일이 첨부된 위치 정보 ("어디에")
    attachable_type attachable_type NOT NULL,
    attachable_id BIGINT NOT NULL,

    -- 4. 정렬 순서
    display_order SMALLINT NOT NULL DEFAULT 0,

    -- 외래 키 제약 조건
    CONSTRAINT fk_uploader_user FOREIGN KEY(uploader_user_id) REFERENCES users(id) ON DELETE SET NULL
);

-- 인덱스 생성
CREATE INDEX idx_attachments_uploader ON attachments(uploader_user_id);
CREATE INDEX idx_attachments_attachable_order ON attachments(attachable_type, attachable_id, display_order);

-- 주석 추가
COMMENT ON TABLE attachments IS '프로필, 채팅 등 모든 첨부파일을 관리하는 중앙 테이블';
COMMENT ON COLUMN attachments.storage_public_id IS 'AWS S3 등의 파일 저장소에서 사용하는 고유 키 (Object Key)';
COMMENT ON COLUMN attachments.uploader_user_id IS '파일을 업로드한 회원의 ID (users.id)';
COMMENT ON COLUMN attachments.attachable_type IS '파일이 첨부된 도메인/테이블의 타입 (예: EXERCISE_INFO, USER_PROFILE, USER_INFO, CHAT_MESSAGE, REVIEW, POST)';
COMMENT ON COLUMN attachments.attachable_id IS '첨부된 도메인의 실제 ID (예: users.id, posts.id)';
COMMENT ON COLUMN attachments.display_order IS '첨부된 목록 내에서의 정렬 순서 (0부터 시작, 숫자가 작을수록 우선순위 높음)';